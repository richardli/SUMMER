---
title: "Spatio-temporal Under-five Mortality Methods for Estimation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Spatio-temporal Under-five Mortality Methods for Estimation}
  %\usepackage[utf8]{inputenc}
---

```{r, echo = FALSE}
# Uncomment to enter DEBUG mode. The package vignette will compile, but code will not be evaluated for speed purposes.
knitr::opts_chunk$set(eval = FALSE)
```

## Load Package and Data

TODO: Fix, no longer Uganda.


`DemoData` contains model survey data provided by DHS. Note that this data is fake, and does not represent any real country's data. Data similar to the `DemoData` data used in this vignette can be obtained by using  `getBirths`. `DemoMap` contains geographic data from the 1995 Uganda Admin 1 regions defined by DHS. Data similar to the `DemoMap` data used in this vignette can be obtained by using `read_shape`.

First, we load the package and load the necessary data. INLA is not in a standard repository, so we check if it is available and install it if it is not.

```{r, message = FALSE}
library(SUMMER)
if (!isTRUE(requireNamespace("INLA", quietly = TRUE))) {
  install.packages('INLA', repos = 'https://www.math.ntnu.no/inla/R/stable')
}

data(DemoData)
data(DemoMap)
```

`DemoData` is a list of $5$ data frames where each row represent one person-month record and contains the $8$ variables as shown below. Notice that `time` variable is turned into 5-year bins from `80-84` to `10-14`. 

```{r, message=FALSE}
summary(DemoData)
head(DemoData[[1]])
```

`DemoData` is obtained by processing the raw DHS birth data (in .dta format) in R. The raw file of birth recodes can be downloaded from the DHS website [https://dhsprogram.com/data/Download-Model-Datasets.cfm](https://dhsprogram.com/data/Download-Model-Datasets.cfm). For this example dataset, no registration is needed. For real DHS survey datasets, permission to access needs to be registered with DHS directly. `DemData` contains a small sample of the observations in this dataset randomly assigned to $5$ example DHS surveys.

Here we demonstrate how to split the raw data into person-month format from. Notice that to read the file from early version of stata, the package `readstata13` is required. The following script is based on the example dataset `ZZBR62FL.DTA` available from the DHS website. We use the interaction of v024 and v025 as the strata indicator for the purpose of demonstration.

```{r, message=FALSE, eval=FALSE}
library(readstata13)
my_fp <- "data/ZZBR62DT/ZZBR62FL.DTA" 
dat <- getBirths(filepath = my_fp, surveyyear = 2015, strata = c("v024", "v025")) 
dat <- dat[,c("v001","v002","v024","per5","ageGrpD","v005","strata","died")]
colnames(dat) <- c("clustid","id","region","time","age","weights","strata","died")
```

## Make Country Summary

Next, we obtain Horvitz-Thompson estimators using `countrySummary_mult`.


```{r, warning=FALSE}
years <- levels(DemoData[[1]]$time)

data <- countrySummary_mult(births = DemoData, years = years, idVar = "id", regionVar = "region",
                           timeVar = "time", clusterVar = "~clustid+id", ageVar = "age",
                           weightsVar = "weights", geo.recode = NULL)
```

## Read Maps

In this step, we separate the output from `read_shape` to use as function arguments.

```{r, message = FALSE}
    geo <- DemoMap$geo
    mat <- DemoMap$Amat
```


## Make Priors

Using our adjacency matrix, we simulate hyperpriors using `simhyper`. The default INLA analysis scales the marginal variance of all structured random effects, so we only need to one set of hyperparameters with `only.iid` set to true. 

```{r}
priors <- simhyper(R = 2, nsamp = 1e+05, nsamp.check = 5000, Amat = mat, only.iid = TRUE)
```


## Prepare data for meta analysis
Before fitting the model, we first aggregate estimators from different surveys. 

TODO: please use aggregateSurvey here
```{r}
dim(data)
data <- aggregateSurvey(data)
dim(data)
```


## Fit INLA Model for national estimates
Now we are ready to fit the models. The codes to perform the new model fitting is attached at the end of this documentation.

First, we ignore the subnational estimates, and fit a model with temporal random effects only. In this part, we use the subset of data region variable being "All". 

### Period model
In fitting this model, we first define the list of time periods we wish to project the estimates on. First we can fit a Random Walk 2 only model defined on the 5-year period.

```{r, message = FALSE}
years.all <- c(years, "15-19")
fit1 <- fitINLA(data = data, geo = NULL, Amat = NULL, year_names = years.all, year_range = c(1985, 2019), priors = priors, rw = 2, is.yearly=FALSE, m = 5)
```

### Yearly model
Similarly as before, we can estimate the Random Walk 2 random effects on the yearly scale. 
```{r, message = FALSE}
fit2 <- fitINLA(data = data, geo = NULL, Amat = NULL, year_names = years.all, year_range = c(1985, 2019), priors = priors, rw = 2, is.yearly=TRUE, m = 5)
```

### Obtain smoothed estimates
The marginal posteriors are already stored in the fitted object. We use the following function to extract and re-arrange them.

```{r}
out1 <- projINLA(fit1, is.yearly = FALSE)
out2 <- projINLA(fit2, is.yearly = TRUE)
```

We can compare the results visually using the function below.

```{r}
library(ggplot2)
library(gridExtra)
g <- NULL
g[[1]] <- plot(out1, is.yearly=FALSE, is.subnational=FALSE) + ggtitle("National period model")
g[[2]] <- plot(out2, is.yearly=TRUE, is.subnational=FALSE) + ggtitle("National yearly model")
grid.arrange(grobs=g, ncol = 2)
```



## Fit INLA model for subnational estimates
Similarly we can fit the full model on all subnational regions. 

### Period model

```{r, message = FALSE}
fit3 <- fitINLA(data = data, geo = geo, Amat = mat, year_names = years.all, year_range = c(1985, 2019), priors = priors, rw = 2, is.yearly=FALSE, m = 5)
out3 <- projINLA(fit3, Amat = mat, is.yearly = FALSE)
```

### Yearly model with type IV interaction
```{r, message = FALSE}
fit4 <- fitINLA(data = data, geo = geo, Amat = mat, year_names = years.all, year_range = c(1985, 2019), priors = priors, rw = 2, is.yearly=TRUE, m = 5, type.st = 4)
out4 <- projINLA(fit4, Amat = mat, is.yearly = TRUE)
```

### Compare plots
```{r}
g2 <- NULL
g2[[1]] <- plot(out3, is.yearly=FALSE, is.subnational=TRUE) + ggtitle("Subnational period model")
g2[[2]] <- plot(out4, is.yearly=TRUE, is.subnational=TRUE) + ggtitle("Subnational yearly model")
grid.arrange(grobs=g2, ncol = 2)
```




<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="SUMMER">
<title>Case Study: Estimating Subnational U5MR using DHS data • SUMMER</title>
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Case Study: Estimating Subnational U5MR using DHS data">
<meta property="og:description" content="SUMMER">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../../index.html">SUMMER</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.4.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../../articles/web_only/small-area-estimation.html">Generic small area estimation</a>
    <a class="dropdown-item" href="../../articles/web_only/u5mr-vignette.html">Estimating Subnational U5MR using Simulated Data</a>
    <a class="dropdown-item" href="../../articles/web_only/u5mr-dhs-vignette.html">Estimating Subnational U5MR using DHS Data</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/richardli/SUMMER/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Case Study: Estimating Subnational U5MR using DHS data</h1>
                        <h4 data-toc-skip class="author">Zehang Richard
Li</h4>
            
            <h4 data-toc-skip class="date">2024-02-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/richardli/SUMMER/blob/HEAD/vignettes/articles/web_only/u5mr-dhs-vignette.Rmd" class="external-link"><code>vignettes/articles/web_only/u5mr-dhs-vignette.Rmd</code></a></small>
      <div class="d-none name"><code>u5mr-dhs-vignette.Rmd</code></div>
    </div>

    
    
<p>In this vignette, we use real data from Kenya 2014 DHS survey to
illustrate spatial and spatial-temporal smoothing of child mortality
rates using smoothed direct estimation. We focus on subnational
under-five mortality rates (U5MR) is this example, although similar
analysis could be carried out for other quantities of interest such as
neonate mortality rates. We use Kenya 2014 DHS survey as an example and
calculate subnational estimates at province levels for 5-year periods.
The SAE model we discuss use direct estimates for 5-year periods as
input, and produces estimates on both period and yearly levels.</p>
<div class="section level2">
<h2 id="pre-processing-the-data">Pre-processing the data<a class="anchor" aria-label="anchor" href="#pre-processing-the-data"></a>
</h2>
<p>First, we load the package and the necessary data. INLA is not in a
standard repository, so we check if it is available and install it if it
is not installed. For this vignette, we used INLA version 20.03.17.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/richardli/SUMMER" class="external-link">SUMMER</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rdhs/" class="external-link">rdhs</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://haven.tidyverse.org" class="external-link">haven</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span></code></pre></div>
<p>The DHS data can be obtained from the DHS program website at <a href="https://dhsprogram.com/data/dataset/Kenya_Standard-DHS_2014.cfm?flag=0" class="external-link">https://dhsprogram.com/data/dataset/Kenya_Standard-DHS_2014</a>.
For the analysis of U5MR, we will use the Births Recode in .dta format.
Notice that registration with the DHS program is required in order to
access this dataset. Below we show two ways to read in the files.</p>
<p>One option is to download both the DHS birth record data and the
corresponding shapefiles from the website and save them in the local
directory. We can load them into with packages
<strong>readstata13</strong>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sjewo/readstata13" class="external-link">readstata13</a></span><span class="op">)</span></span>
<span><span class="va">filename</span> <span class="op">&lt;-</span> <span class="st">"data/KEBR71DT/KEBR71FL.DTA"</span></span>
<span><span class="va">births</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/readstata13/man/read.dta13.html" class="external-link">read.dta13</a></span><span class="op">(</span><span class="va">filename</span>, generate.factors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Another option is to use the <strong>rdhs</strong> package. It allows
users to download DHS datasets directly from within R session. We first
look up the DHS surveys in Kenya.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/rdhs/reference/dhs_surveys.html" class="external-link">dhs_surveys</a></span><span class="op">(</span>countryIds <span class="op">=</span> <span class="st">"KE"</span>, surveyType <span class="op">=</span> <span class="st">"DHS"</span><span class="op">)</span></span>
<span><span class="va">sv</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SurveyId"</span>, <span class="st">"FieldworkStart"</span>, <span class="st">"FieldworkEnd"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##    SurveyId FieldworkStart FieldworkEnd</span></span>
<span><span class="co">## 1 KE1989DHS     1988-12-01   1989-05-01</span></span>
<span><span class="co">## 2 KE1993DHS     1993-02-01   1993-08-01</span></span>
<span><span class="co">## 3 KE1998DHS     1998-02-01   1998-07-01</span></span>
<span><span class="co">## 4 KE2003DHS     2003-04-01   2003-09-01</span></span>
<span><span class="co">## 5 KE2008DHS     2008-11-01   2009-02-01</span></span>
<span><span class="co">## 6 KE2014DHS     2014-05-01   2014-10-01</span></span>
<span><span class="co">## 7 KE2022DHS     2022-02-01   2022-07-01</span></span></code></pre>
<p>We download the 2014 Kenya DHS data. Notice for the first time users,
a DHS key is required from registering at DHS website and in the
<strong>rdhs</strong> package.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">BR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/rdhs/reference/dhs_datasets.html" class="external-link">dhs_datasets</a></span><span class="op">(</span>surveyIds <span class="op">=</span> <span class="va">sv</span><span class="op">$</span><span class="va">SurveyId</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span>, fileFormat <span class="op">=</span> <span class="st">"STATA"</span>, fileType <span class="op">=</span> <span class="st">"BR"</span><span class="op">)</span></span>
<span><span class="va">BRfiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/rdhs/reference/get_datasets.html" class="external-link">get_datasets</a></span><span class="op">(</span><span class="va">BR</span><span class="op">$</span><span class="va">FileName</span>, reformat <span class="op">=</span> <span class="cn">TRUE</span>, download_option <span class="op">=</span> <span class="st">"zip"</span><span class="op">)</span></span>
<span><span class="va">BRfiles</span></span></code></pre></div>
<pre><code><span><span class="co">## $KEBR72DT</span></span>
<span><span class="co">## [1] "~/Library/Caches/rdhs/datasets_reformatted/KEBR72DT.ZIP"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attr(,"reformat")</span></span>
<span><span class="co">## [1] TRUE</span></span></code></pre>
<p>We use the <strong>haven</strong> package to read in the birth record
file from the downloaded zip folder and make the region variable
<code>v024</code> into factors.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">births</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://haven.tidyverse.org/reference/read_dta.html" class="external-link">read_dta</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">unz</a></span><span class="op">(</span><span class="va">BRfiles</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="st">"KEBR72FL.DTA"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">births</span><span class="op">$</span><span class="va">v024</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html" class="external-link">as_factor</a></span><span class="op">(</span><span class="va">births</span><span class="op">$</span><span class="va">v024</span><span class="op">)</span></span>
<span><span class="va">births</span><span class="op">$</span><span class="va">b5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html" class="external-link">as_factor</a></span><span class="op">(</span><span class="va">births</span><span class="op">$</span><span class="va">b5</span><span class="op">)</span></span></code></pre></div>
<p>The map files for this DHS can be freely downloaded from <a href="https://spatialdata.dhsprogram.com/boundaries/" class="external-link">https://spatialdata.dhsprogram.com/boundaries/</a>.
We load the downloaded shapefile from using the <strong>sf</strong>
package. We also generates the spatial adjacency matrix
<code>Amat</code> using the function <code><a href="../../reference/getAmat.html">getAmat()</a></code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mapfilename</span> <span class="op">&lt;-</span> <span class="st">"data/shps/sdr_subnational_boundaries.shp"</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html" class="external-link">sf_use_s2</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">geo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">mapfilename</span><span class="op">)</span></span>
<span><span class="va">Amat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/getAmat.html">getAmat</a></span><span class="op">(</span><span class="va">geo</span>, <span class="va">geo</span><span class="op">$</span><span class="va">REGNAME</span><span class="op">)</span></span></code></pre></div>
<p>The <code>Amat</code> matrix encodes the spatial adjacency matrix of
the 8 Admin-1 region groups, with column and row names matching the
regions used in the map. This adjacency matrix will be used for the
spatial smoothing model. It can also be created by hand if
necessary.</p>
</div>
<div class="section level2">
<h2 id="bayesian-space-time-smoothing-of-direct-estimates">Bayesian space-time smoothing of direct estimates<a class="anchor" aria-label="anchor" href="#bayesian-space-time-smoothing-of-direct-estimates"></a>
</h2>
<div class="section level3">
<h3 id="prepare-person-month-data">Prepare person-month data<a class="anchor" aria-label="anchor" href="#prepare-person-month-data"></a>
</h3>
<p>We first demonstrate the method that smooths the direct estimates of
subnational-level U5MR. For this analysis, we consider the <span class="math inline">\(8\)</span> Admin-1 region groups. In order to
calculate the direct estimates of U5MR, we need the full birth history
data in the format so that every row corresponds to a birth and columns
that contain:</p>
<ul>
<li>Indicators corresponding to survey design, e.g., strata
(<code>v023</code>), cluster (<code>v001</code>), and household
(<code>v002</code>)</li>
<li>Survey weight (<code>v025</code>)</li>
<li>Date of interview in century month codes (CMC) format, i.e., the
number of the month since the beginning of 1900 (<code>v008</code>)</li>
<li>Date of child’s birth in CMC format (<code>b3</code>)</li>
<li>Indicator for death of child (<code>b5</code>)</li>
<li>Age of death of child in months (<code>b7</code>)</li>
</ul>
<p>The birth history data from DHS is already in this form and the
<code>getBirths</code> function default to use the current recode manual
column names (as indicated above). The name of these fields can be
defined explicitly in the function arguments too. We reorganize the data
into the ‘person-month’ format with <code>getBirths</code> function and
reorder the columns for better readability. Notice that DHS reports age
in years for children over 2 years old. Thus the <code>b7</code>
variable contains ages mostly in multiples of 12 after 24 months. This
truncation is adjusted by the <code>age.truncate = 24</code> argument,
which adds 5 months to the age of the children for any records at least
24 months old and the age being multiples of 12. We also specify the
<code>surveyyear</code> argument to remove any observations that fall
into time periods after 2014, which could exist in the adjusted
dataset.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/getBirths.html">getBirths</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">births</span>, strata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"v023"</span><span class="op">)</span>, surveyyear <span class="op">=</span> <span class="fl">2014</span>, year.cut <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1985</span>,</span>
<span>    <span class="fl">2020</span>, by <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"v001"</span>, <span class="st">"v002"</span>, <span class="st">"v024"</span>, <span class="st">"time"</span>, <span class="st">"age"</span>, <span class="st">"v005"</span>, <span class="st">"strata"</span>, <span class="st">"died"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"clustid"</span>, <span class="st">"id"</span>, <span class="st">"region"</span>, <span class="st">"time"</span>, <span class="st">"age"</span>, <span class="st">"weights"</span>, <span class="st">"strata"</span>,</span>
<span>    <span class="st">"died"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   clustid id  region  time  age weights strata died</span></span>
<span><span class="co">## 1       1  6 nairobi 05-09    0 5476381      1    0</span></span>
<span><span class="co">## 2       1  6 nairobi 05-09 1-11 5476381      1    0</span></span>
<span><span class="co">## 3       1  6 nairobi 05-09 1-11 5476381      1    0</span></span>
<span><span class="co">## 4       1  6 nairobi 05-09 1-11 5476381      1    0</span></span>
<span><span class="co">## 5       1  6 nairobi 05-09 1-11 5476381      1    0</span></span>
<span><span class="co">## 6       1  6 nairobi 05-09 1-11 5476381      1    0</span></span></code></pre>
<p>Notice that we also need to specify the time intervals of interest.
In this example, we with to calculate and predict U5MR in 5-year
intervals from 1985-1990 to 2015-2019. For U5MR, we will use the
discrete survival model to calculate direct estimates for each region
and time. This step involves breaking down the age of each death into
discrete intervals. The default option assumes a discrete survival model
with six discrete hazards (probabilities of dying in a particular
interval, given survival to the start of the interval) for each of the
age bands: <span class="math inline">\([0,1), [1,12), [12,24), [24,36),
[36,48)\)</span>, and <span class="math inline">\([48,60]\)</span>.</p>
<p>We may also calculate other types of mortality rates of interest
using <code>getBirths</code>. For example, for U1MR,</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_infant</span> <span class="op">=</span> <span class="fu"><a href="../../reference/getBirths.html">getBirths</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">births</span>, surveyyear <span class="op">=</span> <span class="fl">2014</span>, month.cut <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">12</span><span class="op">)</span>, strata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"v023"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>And the smoothing steps can be similarly carried out.</p>
</div>
<div class="section level3">
<h3 id="horvitz-thompson-estimators-of-u5mr">Horvitz-Thompson estimators of U5MR<a class="anchor" aria-label="anchor" href="#horvitz-thompson-estimators-of-u5mr"></a>
</h3>
<p>Using the person-month format data, we can calculate Horvitz-Thompson
estimators using <code>getDirect</code> for a single survey or
<code>getDirectList</code> for multiple surveys. The discrete hazards in
each time interval are estimated using a logistic regression model, with
weighting to account for the survey design. The direct estimates are
then calculated using the discrete hazards. In order to correctly
account for survey design, We need to specify the stratification and
cluster variables. In the Kenya DHS example, a two-stage stratified
cluster sampling design was used, where strata are specified in the
<code>strata</code> column, and clusters are specified by the cluster ID
(<code>clusterid</code>) and household ID (<code>id</code>).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">time</span><span class="op">)</span></span>
<span><span class="va">direct0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/getDirect.html">getDirect</a></span><span class="op">(</span>births <span class="op">=</span> <span class="va">dat</span>, years <span class="op">=</span> <span class="va">years</span>, regionVar <span class="op">=</span> <span class="st">"region"</span>, timeVar <span class="op">=</span> <span class="st">"time"</span>,</span>
<span>    clusterVar <span class="op">=</span> <span class="st">"~clustid + id"</span>, ageVar <span class="op">=</span> <span class="st">"age"</span>, weightsVar <span class="op">=</span> <span class="st">"weights"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">direct0</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   region years  mean lower upper logit.est var.est survey logit.prec</span></span>
<span><span class="co">## 1    All 85-89 0.093 0.079 0.109      -2.3  0.0082     NA        122</span></span>
<span><span class="co">## 2    All 90-94 0.098 0.089 0.109      -2.2  0.0033     NA        306</span></span>
<span><span class="co">## 3    All 95-99 0.088 0.081 0.097      -2.3  0.0024     NA        409</span></span>
<span><span class="co">## 4    All 00-04 0.078 0.072 0.084      -2.5  0.0016     NA        630</span></span>
<span><span class="co">## 5    All 05-09 0.059 0.054 0.064      -2.8  0.0020     NA        506</span></span>
<span><span class="co">## 6    All 10-14 0.051 0.047 0.056      -2.9  0.0021     NA        472</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="adjustments-using-external-information">Adjustments using external information<a class="anchor" aria-label="anchor" href="#adjustments-using-external-information"></a>
</h3>
<p>Sometimes additional information are available to adjust the direct
estimates from the surveys. For example, in countries with high
prevalence of HIV, estimates of U5MR can be biased, particularly before
ART treatment became widely available. Pre-treatment HIV positive women
had a high risk of dying, and such women who had given birth were
therefore less likely to appear in surveys. The children of HIV positive
women are also more likely to have a higher probability of dying
compared to those born to HIV negative women. Thus we expect that the
U5MR is underestimated if we do not adjust for the missing women.</p>
<p>Suppose we can obtain the ratio of the reported U5MR to the true
U5MR, <span class="math inline">\(r_{it}\)</span>, at region <span class="math inline">\(i\)</span> and time period <span class="math inline">\(t\)</span>, we can apply the adjustment factor to
the direct estimates and the associated variances. The HIV adjustment
factors were calculated for the 2014 Kenya DHS survey and included in
the package.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">KenData</span><span class="op">)</span></span>
<span><span class="va">direct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/getAdjusted.html">getAdjusted</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">direct0</span>, ratio <span class="op">=</span> <span class="va">KenData</span><span class="op">$</span><span class="va">HIV2014</span>, logit.lower <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    logit.upper <span class="op">=</span> <span class="cn">NA</span>, prob.lower <span class="op">=</span> <span class="st">"lower"</span>, prob.upper <span class="op">=</span> <span class="st">"upper"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="national-estimates-of-u5mr">National estimates of U5MR<a class="anchor" aria-label="anchor" href="#national-estimates-of-u5mr"></a>
</h3>
<p>The direct estimates calculated using <code>getDirect</code> contains
both national estimates and subnational estimates for the <span class="math inline">\(8\)</span> regions, over the <span class="math inline">\(6\)</span> time periods and the projection period
2015-2019. We first fit a model with temporal random effects only to
smooth the national estimates over time. In this part, we use the subset
of data region variable being “All”. We can fit a Random Walk 2 only
model defined on the 5-year period.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/smoothDirect.html">smoothDirect</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">direct</span>, Amat <span class="op">=</span> <span class="cn">NULL</span>, year_label <span class="op">=</span> <span class="va">years</span>, year_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1985</span>,</span>
<span>    <span class="fl">2019</span><span class="op">)</span>, time.model <span class="op">=</span> <span class="st">"rw2"</span>, m <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>We can also estimate the Random Walk 2 random effects on the yearly
scale.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/smoothDirect.html">smoothDirect</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">direct</span>, Amat <span class="op">=</span> <span class="cn">NULL</span>, year_label <span class="op">=</span> <span class="va">years</span>, year_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1985</span>,</span>
<span>    <span class="fl">2019</span><span class="op">)</span>, time.model <span class="op">=</span> <span class="st">"rw2"</span>, m <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p>The marginal posteriors are already stored in the fitted object. We
use the following function to extract and re-arrange them.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/getSmoothed.html">getSmoothed</a></span><span class="op">(</span><span class="va">fit1</span><span class="op">)</span></span>
<span><span class="va">out2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/getSmoothed.html">getSmoothed</a></span><span class="op">(</span><span class="va">fit2</span><span class="op">)</span></span></code></pre></div>
<p>We can compare the results visually. Notice to correctly display the
period estimates, the reference year in each period needs to be
specified. Here we simply take the median year in each period.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">years.ref</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1987</span>, <span class="fl">1992</span>, <span class="fl">1997</span>, <span class="fl">2002</span>, <span class="fl">2007</span>, <span class="fl">2012</span>, <span class="fl">2017</span><span class="op">)</span></span>
<span><span class="va">g1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">out1</span>, year_med <span class="op">=</span> <span class="va">years.ref</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"National period model"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,</span>
<span>    <span class="fl">0.17</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">g2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">out2</span>, year_med <span class="op">=</span> <span class="va">years.ref</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"National yearly model"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,</span>
<span>    <span class="fl">0.17</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">g1</span> <span class="op">+</span> <span class="va">g2</span></span></code></pre></div>
<p><img src="figure/unnamed-chunk-15-1.png" width="90%"></p>
<p>The national model also allows us to benchmark the estimates using
other published national results. For example, we take the 2019 UN-IGME
estimates and find the median under-5 mortality rates in each periods.
We can then calculate the ratio of the estimates from national models to
the published UN estimates.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">KenData</span><span class="op">)</span></span>
<span><span class="va">UN</span> <span class="op">&lt;-</span> <span class="va">KenData</span><span class="op">$</span><span class="va">IGME2019</span></span>
<span><span class="va">UN.period</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"85-89"</span>, <span class="st">"90-94"</span>, <span class="st">"95-99"</span>, <span class="st">"00-04"</span>, <span class="st">"05-09"</span>, <span class="st">"10-14"</span><span class="op">)</span>,</span>
<span>    median <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">UN.period</span><span class="op">$</span><span class="va">median</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">UN</span><span class="op">$</span><span class="va">mean</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">UN</span><span class="op">$</span><span class="va">years</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1985</span><span class="op">:</span><span class="fl">1989</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">i</span> <span class="op">-</span></span>
<span>        <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">ratio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">out1</span>, <span class="va">region</span> <span class="op">==</span> <span class="st">"All"</span><span class="op">)</span><span class="op">$</span><span class="va">median</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">/</span><span class="va">UN.period</span><span class="op">$</span><span class="va">median</span></span>
<span><span class="fu"><a href="https://www.math.uzh.ch/pages/spam/reference/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">ratio</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.98 0.95 0.91 0.95 0.92 1.00</span></span></code></pre>
<p>We will use this adjustment ratio to correct the bias from our direct
estimates. We organize the adjustment ratios into a matrix of two
columns, since the adjustment factor only varies over time. We can then
perform the benchmarking to the UN estimates similar to the HIV
adjustment before.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">benchmark</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>years <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"85-89"</span>, <span class="st">"90-94"</span>, <span class="st">"95-99"</span>, <span class="st">"00-04"</span>, <span class="st">"05-09"</span>, <span class="st">"10-14"</span><span class="op">)</span>,</span>
<span>    ratio <span class="op">=</span> <span class="va">ratio</span><span class="op">)</span></span>
<span><span class="va">direct</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/getAdjusted.html">getAdjusted</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">direct</span>, ratio <span class="op">=</span> <span class="va">benchmark</span>, time <span class="op">=</span> <span class="st">"years"</span>, region <span class="op">=</span> <span class="st">"region"</span>,</span>
<span>    est <span class="op">=</span> <span class="st">"mean"</span>, logit.lower <span class="op">=</span> <span class="st">"logit.lower"</span>, logit.upper <span class="op">=</span> <span class="st">"logit.upper"</span><span class="op">)</span></span></code></pre></div>
<p>After benchmarking, we can fit the smoothing model again on the
adjusted direct estimates, and see if they align with the UN
estimates.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit2.benchmark</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/smoothDirect.html">smoothDirect</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">direct</span>, Amat <span class="op">=</span> <span class="cn">NULL</span>, year_label <span class="op">=</span> <span class="va">years</span>, year_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1985</span>,</span>
<span>    <span class="fl">2019</span><span class="op">)</span>, time.model <span class="op">=</span> <span class="st">"rw2"</span>, m <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">out2.benchmark</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/getSmoothed.html">getSmoothed</a></span><span class="op">(</span><span class="va">fit2.benchmark</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">out2</span>, year_label <span class="op">=</span> <span class="va">years</span>, year_med <span class="op">=</span> <span class="va">years.ref</span>, data.add <span class="op">=</span> <span class="va">UN</span>, option.add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>point <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span>,</span>
<span>    label.add <span class="op">=</span> <span class="st">"UN"</span>, color.add <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"National yearly model: original"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.17</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">g2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">out2.benchmark</span>, year_label <span class="op">=</span> <span class="va">years</span>, year_med <span class="op">=</span> <span class="va">years.ref</span>, data.add <span class="op">=</span> <span class="va">UN</span>,</span>
<span>    option.add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>point <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span>, label.add <span class="op">=</span> <span class="st">"UN"</span>, color.add <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"National yearly model: benchmarked"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.17</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">g1</span> <span class="op">+</span> <span class="va">g2</span></span></code></pre></div>
<p><img src="figure/unnamed-chunk-18-1.png" width="90%"></p>
</div>
<div class="section level3">
<h3 id="subnational-estimates-of-u5mr">Subnational estimates of U5MR<a class="anchor" aria-label="anchor" href="#subnational-estimates-of-u5mr"></a>
</h3>
<p>The syntax to fit subnational smoothing model is similar. Similar to
the national model, we can choose to estimate temporal random effects on
either yearly or period level. We can also choose the four types of
space-time interaction terms using the <code>st.type</code> argument.
The default hyper priors on the precision of random effects are now PC
priors.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/smoothDirect.html">smoothDirect</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">direct</span>, Amat <span class="op">=</span> <span class="va">Amat</span>, year_label <span class="op">=</span> <span class="va">years</span>, year_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1985</span>,</span>
<span>    <span class="fl">2019</span><span class="op">)</span>, time.model <span class="op">=</span> <span class="st">"rw2"</span>, type.st <span class="op">=</span> <span class="fl">4</span>, m <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">out3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/getSmoothed.html">getSmoothed</a></span><span class="op">(</span><span class="va">fit3</span><span class="op">)</span></span></code></pre></div>
<p>Similarly we can also estimate the Random Walk 2 random effects on
the yearly scale.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/smoothDirect.html">smoothDirect</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">direct</span>, Amat <span class="op">=</span> <span class="va">Amat</span>, year_label <span class="op">=</span> <span class="va">years</span>, year_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1985</span>,</span>
<span>    <span class="fl">2019</span><span class="op">)</span>, time.model <span class="op">=</span> <span class="st">"rw2"</span>, type.st <span class="op">=</span> <span class="fl">4</span>, m <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">out4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/getSmoothed.html">getSmoothed</a></span><span class="op">(</span><span class="va">fit4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">g1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">out3</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Subnational period model"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">g2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">out4</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Subnational yearly model"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">g1</span> <span class="op">+</span> <span class="va">g2</span></span></code></pre></div>
<p><img src="figure/unnamed-chunk-20-1.png" width="90%"></p>
<p>We can also add back the direct estimates for comparison.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">out4</span>, data.add <span class="op">=</span> <span class="va">direct</span>, option.add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>point <span class="op">=</span> <span class="st">"mean"</span>, by <span class="op">=</span> <span class="st">"survey"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">region</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/unnamed-chunk-21-1.png" width="90%"></p>
<p>We can show the estimates over time on maps. We revert the color
scale so that higher mortality are represented by darker colors.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/mapPlot.html">mapPlot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">out4</span>, <span class="va">is.yearly</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span>, geo <span class="op">=</span> <span class="va">geo</span>, variables <span class="op">=</span> <span class="st">"years"</span>,</span>
<span>    values <span class="op">=</span> <span class="st">"median"</span>, by.data <span class="op">=</span> <span class="st">"region"</span>, by.geo <span class="op">=</span> <span class="st">"REGNAME"</span>, is.long <span class="op">=</span> <span class="cn">TRUE</span>, ncol <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, legend.label <span class="op">=</span> <span class="st">"U5MR"</span>, per1000 <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/unnamed-chunk-22-1.png" width="90%"></p>
<p>In order to also illustrate uncertainties of the estimates when
presented on maps, we can use hatching to indicate the width of the 94%
posterior credible intervals.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../../reference/hatchPlot.html">hatchPlot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">out4</span>, <span class="va">is.yearly</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span>, geo <span class="op">=</span> <span class="va">geo</span>, variables <span class="op">=</span> <span class="st">"years"</span>,</span>
<span>    values <span class="op">=</span> <span class="st">"median"</span>, by.data <span class="op">=</span> <span class="st">"region"</span>, by.geo <span class="op">=</span> <span class="st">"REGNAME"</span>, lower <span class="op">=</span> <span class="st">"lower"</span>, upper <span class="op">=</span> <span class="st">"upper"</span>,</span>
<span>    is.long <span class="op">=</span> <span class="cn">TRUE</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, legend.label <span class="op">=</span> <span class="st">"U5MR"</span>, per1000 <span class="op">=</span> <span class="cn">TRUE</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/unnamed-chunk-23-1.png" width="90%"></p>
</div>
</div>
<div class="section level2">
<h2 id="comparing-different-models">Comparing different models<a class="anchor" aria-label="anchor" href="#comparing-different-models"></a>
</h2>
<p>In this section, we compare models with different prior setup. We
focus on the subnational models with yearly temporal resolution. We use
random walk of order 2 to model the main temporal trend, and compare
different priors for the space-time interaction term. We consider both
random walk of order 1 and 2, and PC priors with <span class="math inline">\(U = 1, 5\)</span>. It can be seen that with RW2
interaction, the region specific U5MR are allowed to follow their own
trends with no regulation in their slopes. On the other hand, RW1
interaction stays constant after observation periods ends instead of
following region-specific trends. This can be seen more clearly with the
interaction effect plots at the end. The posterior is not sensitive to
the choice of <span class="math inline">\(U\)</span>.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">f.list</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">est.list</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">model</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rw1"</span>, <span class="st">"rw2"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">u</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/smoothDirect.html">smoothDirect</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">direct</span>, Amat <span class="op">=</span> <span class="va">Amat</span>, year_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1985</span>, <span class="fl">2019</span><span class="op">)</span>,</span>
<span>            year_label <span class="op">=</span> <span class="va">years</span>, time.model <span class="op">=</span> <span class="st">"rw2"</span>, st.time.model <span class="op">=</span> <span class="va">model</span>, m <span class="op">=</span> <span class="fl">5</span>,</span>
<span>            type.st <span class="op">=</span> <span class="fl">4</span>, pc.st.u <span class="op">=</span> <span class="va">u</span>, pc.st.alpha <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span>        <span class="va">f.list</span><span class="op">[[</span><span class="va">index</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">f</span></span>
<span>        <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/getSmoothed.html">getSmoothed</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span>        <span class="va">out</span><span class="op">$</span><span class="va">st.model</span> <span class="op">&lt;-</span> <span class="va">model</span></span>
<span>        <span class="va">out</span><span class="op">$</span><span class="va">st.u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"U ="</span>, <span class="va">u</span><span class="op">)</span></span>
<span>        <span class="va">est.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://www.math.uzh.ch/pages/spam/reference/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">est.list</span>, <span class="va">out</span><span class="op">)</span></span>
<span>        <span class="va">index</span> <span class="op">&lt;-</span> <span class="va">index</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">est.list</span>, plot.CI <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">st.model</span> <span class="op">~</span> <span class="va">st.u</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/unnamed-chunk-24-1.png" width="90%"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Zehang R Li, Bryan D Martin, Yuan Hsiao, Jessica Godwin, John Paige, Peter Gao, Jon Wakefield, Samuel J Clark, Geir-Arne Fuglstad, Andrea Riebler.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>

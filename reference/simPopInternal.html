<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Internal functions for population simulation — simPopInternal • SUMMER</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Internal functions for population simulation — simPopInternal"><meta name="description" content="Functions for calculating valuable quantities and for drawing from important
distributions for population simulation."><meta property="og:description" content="Functions for calculating valuable quantities and for drawing from important
distributions for population simulation."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">SUMMER</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.4.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/web_only/small-area-estimation.html">Generic small area estimation</a></li>
    <li><a class="dropdown-item" href="../articles/web_only/u5mr-vignette.html">Estimating Subnational U5MR using Simulated Data</a></li>
    <li><a class="dropdown-item" href="../articles/web_only/u5mr-dhs-vignette.html">Estimating Subnational U5MR using DHS Data</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/richardli/SUMMER/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Internal functions for population simulation</h1>
      <small class="dont-index">Source: <a href="https://github.com/richardli/SUMMER/blob/master/R/simPop.R" class="external-link"><code>R/simPop.R</code></a></small>
      <div class="d-none name"><code>simPopInternal.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Functions for calculating valuable quantities and for drawing from important
distributions for population simulation.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">getExpectedNperEA</span><span class="op">(</span><span class="va">easpa</span>, <span class="va">popMat</span>, level <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"grid"</span>, <span class="st">"EA"</span><span class="op">)</span>, pixelIndexMat <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">getSortIndices</span><span class="op">(</span></span>
<span>  <span class="va">i</span>,</span>
<span>  urban <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">popMat</span>,</span>
<span>  stratifyByUrban <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  validationPixelI <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">rStratifiedMultnomial</span><span class="op">(</span><span class="va">n</span>, <span class="va">popMat</span>, <span class="va">easpa</span>, stratifyByUrban <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">rStratifiedMultnomialBySubarea</span><span class="op">(</span></span>
<span>  <span class="va">n</span>,</span>
<span>  <span class="va">popMat</span>,</span>
<span>  <span class="va">easpa</span>,</span>
<span>  stratifyByUrban <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  poppsub <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  min1PerSubarea <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  minSample <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">rMyMultinomial</span><span class="op">(</span></span>
<span>  <span class="va">n</span>,</span>
<span>  <span class="va">i</span>,</span>
<span>  stratifyByUrban <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  urban <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  popMat <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  easpa <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  min1PerSubarea <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mult1"</span>, <span class="st">"mult"</span>, <span class="st">"indepMH"</span><span class="op">)</span>,</span>
<span>  minSample <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">rMyMultinomialSubarea</span><span class="op">(</span></span>
<span>  <span class="va">n</span>,</span>
<span>  <span class="va">i</span>,</span>
<span>  <span class="va">easpsub</span>,</span>
<span>  stratifyByUrban <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  urban <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  popMat <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">rmultinom1</span><span class="op">(</span></span>
<span>  n <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  <span class="va">size</span>,</span>
<span>  <span class="va">prob</span>,</span>
<span>  maxSize <span class="op">=</span> <span class="fl">8000</span> <span class="op">*</span> <span class="fl">8000</span>,</span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mult1"</span>, <span class="st">"mult"</span>, <span class="st">"indepMH"</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  minSample <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  maxExpectedSizeBeforeSwitch <span class="op">=</span> <span class="fl">1000</span> <span class="op">*</span> <span class="fl">1e+07</span>,</span>
<span>  init <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  burnIn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">n</span><span class="op">/</span><span class="fl">4</span><span class="op">)</span>,</span>
<span>  filterEvery <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  zeroProbZeroSamples <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  allowSizeLessThanK <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">sampleNMultilevelMultinomial</span><span class="op">(</span></span>
<span>  nDraws <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">pixelIndexMat</span><span class="op">)</span>,</span>
<span>  pixelIndexMat <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  urbanMat <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  areaMat <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">easpaList</span>,</span>
<span>  <span class="va">popMat</span>,</span>
<span>  stratifyByUrban <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  returnEAinfo <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  minHHPerEA <span class="op">=</span> <span class="fl">25</span>,</span>
<span>  fixHHPerEA <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  fixPopPerHH <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">sampleNMultilevelMultinomialFixed</span><span class="op">(</span></span>
<span>  <span class="va">clustersPerPixel</span>,</span>
<span>  nDraws <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">pixelIndices</span><span class="op">)</span>,</span>
<span>  pixelIndices <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  urbanVals <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  areaVals <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">easpa</span>,</span>
<span>  <span class="va">popMat</span>,</span>
<span>  stratifyByUrban <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-easpa">easpa<a class="anchor" aria-label="anchor" href="#arg-easpa"></a></dt>
<dd><p>Census frame. See <code><a href="simPop.html">simPopCustom</a></code> for details</p></dd>


<dt id="arg-popmat">popMat<a class="anchor" aria-label="anchor" href="#arg-popmat"></a></dt>
<dd><p>data.frame of pixellated grid of population densities. See <code><a href="simPop.html">simPopCustom</a></code> for details</p></dd>


<dt id="arg-level">level<a class="anchor" aria-label="anchor" href="#arg-level"></a></dt>
<dd><p>Whether to calculate results at the integration grid or EA level</p></dd>


<dt id="arg-pixelindexmat">pixelIndexMat<a class="anchor" aria-label="anchor" href="#arg-pixelindexmat"></a></dt>
<dd><p>Matrix of pixel indices associated with each EA and draw. Not
required by getExpectedNperEA unless level == "EA"</p></dd>


<dt id="arg-i">i<a class="anchor" aria-label="anchor" href="#arg-i"></a></dt>
<dd><p>Index</p></dd>


<dt id="arg-urban">urban<a class="anchor" aria-label="anchor" href="#arg-urban"></a></dt>
<dd><p>If TRUE, calculate only for urban part of the area. If FALSE, for only rural part</p></dd>


<dt id="arg-stratifybyurban">stratifyByUrban<a class="anchor" aria-label="anchor" href="#arg-stratifybyurban"></a></dt>
<dd><p>whether or not to stratify calculations by urban/rural classification</p></dd>


<dt id="arg-validationpixeli">validationPixelI<a class="anchor" aria-label="anchor" href="#arg-validationpixeli"></a></dt>
<dd><p>CURRENTLY FOR TESTING PURPOSES ONLY a set of indices of pixels for which we want to simulate populations (used for pixel level validation)</p></dd>


<dt id="arg-n">n<a class="anchor" aria-label="anchor" href="#arg-n"></a></dt>
<dd><p>Number of samples</p></dd>


<dt id="arg-poppsub">poppsub<a class="anchor" aria-label="anchor" href="#arg-poppsub"></a></dt>
<dd><p>Population per subarea. See <code><a href="simPop.html">simPopCustom</a></code> for details</p></dd>


<dt id="arg-min-persubarea">min1PerSubarea<a class="anchor" aria-label="anchor" href="#arg-min-persubarea"></a></dt>
<dd><p>Whether or not to ensure there is at least 1 EA per subarea. See <code><a href="simPop.html">simPopCustom</a></code> for details</p></dd>


<dt id="arg-minsample">minSample<a class="anchor" aria-label="anchor" href="#arg-minsample"></a></dt>
<dd><p>The minimum number of samples per `chunk` of samples for truncated multinomial sampling. Defaults to 1</p></dd>


<dt id="arg-method">method<a class="anchor" aria-label="anchor" href="#arg-method"></a></dt>
<dd><p>If min1PerSubarea is TRUE, the sampling method for the truncated multinomial to use with rmulitnom1. rmultinom1 automatically
        switches between them depending on the number of expected samples. The methods are:</p><dl><dt>mult1</dt>
<dd><p>rejection sampling from multinomial plus 1 in each category</p></dd>

  <dt>mult</dt>
<dd><p>rejection sampling from multinomial if any category has zero count</p></dd>

  <dt>indepMH</dt>
<dd><p>independent Metropolis-Hastings using multinomial plus 1 distribution as proposal</p></dd>


</dl></dd>


<dt id="arg-easpsub">easpsub<a class="anchor" aria-label="anchor" href="#arg-easpsub"></a></dt>
<dd><p>This could either be total EAs per subarea, or subarea crossed with urban or
rural if stratifyByUrban is TRUE</p></dd>


<dt id="arg-size">size<a class="anchor" aria-label="anchor" href="#arg-size"></a></dt>
<dd><p>Multinomial size parameter. See <code><a href="https://rdrr.io/r/stats/Multinom.html" class="external-link">rmultinom</a></code></p></dd>


<dt id="arg-prob">prob<a class="anchor" aria-label="anchor" href="#arg-prob"></a></dt>
<dd><p>Multinomial probability vector parameter. See <code><a href="https://rdrr.io/r/stats/Multinom.html" class="external-link">rmultinom</a></code></p></dd>


<dt id="arg-maxsize">maxSize<a class="anchor" aria-label="anchor" href="#arg-maxsize"></a></dt>
<dd><p>The maximum number of elements in a matrix drawn from the proposal distribution per sample chunk.</p></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p>Whether to print progress as the function proceeds</p></dd>


<dt id="arg-maxexpectedsizebeforeswitch">maxExpectedSizeBeforeSwitch<a class="anchor" aria-label="anchor" href="#arg-maxexpectedsizebeforeswitch"></a></dt>
<dd><p>Max expected number of samples / k, the number of categories, before switching method</p></dd>


<dt id="arg-init">init<a class="anchor" aria-label="anchor" href="#arg-init"></a></dt>
<dd><p>Initial sample if method is `indepMH`</p></dd>


<dt id="arg-burnin">burnIn<a class="anchor" aria-label="anchor" href="#arg-burnin"></a></dt>
<dd><p>Number of initial samples before samples are collected if method is `indepMH`</p></dd>


<dt id="arg-filterevery">filterEvery<a class="anchor" aria-label="anchor" href="#arg-filterevery"></a></dt>
<dd><p>Store only every filterEvery samples if method is i`indepMH`</p></dd>


<dt id="arg-zeroprobzerosamples">zeroProbZeroSamples<a class="anchor" aria-label="anchor" href="#arg-zeroprobzerosamples"></a></dt>
<dd><p>If TRUE, set samples for parts of prob vector that are zero to zero. Otherwise they are set to one.</p></dd>


<dt id="arg-allowsizelessthank">allowSizeLessThanK<a class="anchor" aria-label="anchor" href="#arg-allowsizelessthank"></a></dt>
<dd><p>If TRUE, then if size &lt; the number of categories (k), returns matrix where each
column is vector of size ones and k - size zeros. If FALSE, throws an error if size &lt; k</p></dd>


<dt id="arg-ndraws">nDraws<a class="anchor" aria-label="anchor" href="#arg-ndraws"></a></dt>
<dd><p>Number of draws</p></dd>


<dt id="arg-urbanmat">urbanMat<a class="anchor" aria-label="anchor" href="#arg-urbanmat"></a></dt>
<dd><p>Matrix of urbanicities associated with each EA and draw</p></dd>


<dt id="arg-areamat">areaMat<a class="anchor" aria-label="anchor" href="#arg-areamat"></a></dt>
<dd><p>Matrix of areas associated with each EA and draw</p></dd>


<dt id="arg-easpalist">easpaList<a class="anchor" aria-label="anchor" href="#arg-easpalist"></a></dt>
<dd><p>A list of length n with each element being of the format of easpa
giving the number of households and EAs
per stratum. It is assumed that the number of EAs per stratum is
the same in each list element. If easpaList is a data frame,
number of households per stratum is assumed constant</p></dd>


<dt id="arg-returneainfo">returnEAinfo<a class="anchor" aria-label="anchor" href="#arg-returneainfo"></a></dt>
<dd><p>Whether a data frame at the EA level is desired</p></dd>


<dt id="arg-minhhperea">minHHPerEA<a class="anchor" aria-label="anchor" href="#arg-minhhperea"></a></dt>
<dd><p>The minimum number of households per EA (defaults to 25, since
that is the number of households sampled per DHS cluster)</p></dd>


<dt id="arg-fixhhperea">fixHHPerEA<a class="anchor" aria-label="anchor" href="#arg-fixhhperea"></a></dt>
<dd><p>If not NULL, the fixed number of households per EA</p></dd>


<dt id="arg-fixpopperhh">fixPopPerHH<a class="anchor" aria-label="anchor" href="#arg-fixpopperhh"></a></dt>
<dd><p>If not NULL, the fixed target population per household</p></dd>


<dt id="arg-clustersperpixel">clustersPerPixel<a class="anchor" aria-label="anchor" href="#arg-clustersperpixel"></a></dt>
<dd><p>CURRENTLY FOR TESTING PURPOSES ONLY a vector of length nIntegrationPoints specifying the number of clusters per pixel if they are fixed</p></dd>


<dt id="arg-pixelindices">pixelIndices<a class="anchor" aria-label="anchor" href="#arg-pixelindices"></a></dt>
<dd><p>A nEA x n matrix of pixel indices associated with each EA per simulation/draw</p></dd>


<dt id="arg-urbanvals">urbanVals<a class="anchor" aria-label="anchor" href="#arg-urbanvals"></a></dt>
<dd><p>A nEA x n matrix of urbanicities associated with each EA per simulation/draw</p></dd>


<dt id="arg-areavals">areaVals<a class="anchor" aria-label="anchor" href="#arg-areavals"></a></dt>
<dd><p>A nEA x n matrix of area names associated with each EA per simulation/draw</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="functions">Functions<a class="anchor" aria-label="anchor" href="#functions"></a></h2>

<ul><li><p><code>getExpectedNperEA()</code>: Calculates expected denominator per enumeration area.</p></li>
<li><p><code>getSortIndices()</code>: For recombining separate multinomials into the draws over all grid points</p></li>
<li><p><code>rStratifiedMultnomial()</code>: Gives nIntegrationPoints x n matrix of draws from the stratified multinomial with values
corresponding to the value of |C^g| for each pixel, g (the number of EAs/pixel)</p></li>
<li><p><code>rStratifiedMultnomialBySubarea()</code>: Gives nIntegrationPoints x n matrix of draws from the stratified multinomial with values</p></li>
<li><p><code>rMyMultinomial()</code>:</p></li>
<li><p><code>rMyMultinomialSubarea()</code>:</p></li>
<li><p><code>rmultinom1()</code>: Random (truncated) multinomial draws conditional on the number of each type being at least one</p></li>
<li><p><code>sampleNMultilevelMultinomial()</code>: Take multilevel multinomial draws first from joint distribution of
number of households per EA given the total per stratum, and then from the joint
distribution of the total target population per household given
the total per stratum</p></li>
<li><p><code>sampleNMultilevelMultinomialFixed()</code>: Same as sampleNMultilevelMultinomial, except the number of EAs per pixel is fixed</p></li>
</ul></div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Zehang R Li, Bryan D Martin, Yuan Hsiao, Jessica Godwin, John Paige, Peter Gao, Jon Wakefield, Samuel J Clark, Geir-Arne Fuglstad, Andrea Riebler.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>


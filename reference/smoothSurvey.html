<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="This function calculates the direct estimates by region and fit a simple spatial smoothing model to the direct estimates adjusting for survey design.
Normal or binary variables are currently supported. For binary variables, the logit transformation is performed on the direct estimates of probabilities, and a Gaussian additive model is fitted on the logit scale using INLA."><title>Fit space-time smoothing models for a generic outcome from complex surveys. — smoothSurvey • SUMMER</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fit space-time smoothing models for a generic outcome from complex surveys. — smoothSurvey"><meta property="og:description" content="This function calculates the direct estimates by region and fit a simple spatial smoothing model to the direct estimates adjusting for survey design.
Normal or binary variables are currently supported. For binary variables, the logit transformation is performed on the direct estimates of probabilities, and a Gaussian additive model is fitted on the logit scale using INLA."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">SUMMER</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.4.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/web_only/small-area-estimation.html">Generic small area estimation</a>
    <a class="dropdown-item" href="../articles/web_only/u5mr-vignette.html">Estimating Subnational U5MR using Simulated Data</a>
    <a class="dropdown-item" href="../articles/web_only/u5mr-dhs-vignette.html">Estimating Subnational U5MR using DHS Data</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/richardli/SUMMER/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Fit space-time smoothing models for a generic outcome from complex surveys.</h1>
      <small class="dont-index">Source: <a href="https://github.com/richardli/SUMMER/blob/HEAD/R/fitspace.R" class="external-link"><code>R/fitspace.R</code></a></small>
      <div class="d-none name"><code>smoothSurvey.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function calculates the direct estimates by region and fit a simple spatial smoothing model to the direct estimates adjusting for survey design.
Normal or binary variables are currently supported. For binary variables, the logit transformation is performed on the direct estimates of probabilities, and a Gaussian additive model is fitted on the logit scale using INLA.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">smoothSurvey</span><span class="op">(</span></span>
<span>  <span class="va">data</span>,</span>
<span>  geo <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  Amat <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  region.list <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  X.unit <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  responseType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"binary"</span>, <span class="st">"gaussian"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  <span class="va">responseVar</span>,</span>
<span>  strataVar <span class="op">=</span> <span class="st">"strata"</span>,</span>
<span>  weightVar <span class="op">=</span> <span class="st">"weights"</span>,</span>
<span>  regionVar <span class="op">=</span> <span class="st">"region"</span>,</span>
<span>  clusterVar <span class="op">=</span> <span class="st">"~v001+v002"</span>,</span>
<span>  pc.u <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  pc.alpha <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>  pc.u.phi <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  pc.alpha.phi <span class="op">=</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span>,</span>
<span>  CI <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>  formula <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  timeVar <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  time.model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rw1"</span>, <span class="st">"rw2"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  include_time_unstruct <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  type.st <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  direct.est <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  direct.est.var <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  is.unit.level <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  is.agg <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  strataVar.within <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  totalVar <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  weight.strata <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  nsim <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  save.draws <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  smooth <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">fitGeneric</span><span class="op">(</span></span>
<span>  <span class="va">data</span>,</span>
<span>  geo <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  Amat <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  region.list <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  X.unit <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  responseType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"binary"</span>, <span class="st">"gaussian"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  <span class="va">responseVar</span>,</span>
<span>  strataVar <span class="op">=</span> <span class="st">"strata"</span>,</span>
<span>  weightVar <span class="op">=</span> <span class="st">"weights"</span>,</span>
<span>  regionVar <span class="op">=</span> <span class="st">"region"</span>,</span>
<span>  clusterVar <span class="op">=</span> <span class="st">"~v001+v002"</span>,</span>
<span>  pc.u <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  pc.alpha <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>  pc.u.phi <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  pc.alpha.phi <span class="op">=</span> <span class="fl">2</span><span class="op">/</span><span class="fl">3</span>,</span>
<span>  CI <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>  formula <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  timeVar <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  time.model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rw1"</span>, <span class="st">"rw2"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  include_time_unstruct <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  type.st <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  direct.est <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  direct.est.var <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  is.unit.level <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  is.agg <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  strataVar.within <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  totalVar <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  weight.strata <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  nsim <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  save.draws <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  smooth <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>data</dt>
<dd><p>The input data frame. The input data  with column of the response variable (<code>responseVar</code>), region ID (<code>regionVar</code>), stratification within region (<code>strataVar</code>), and cluster ID (<code>clusterVar</code>).</p><ul><li><p>For area-level model, the data frame consist of survey observations and corresponding survey weights (<code>weightVar</code>).</p></li>
<li><p>For unit-level model and <code>is.agg = FALSE</code>, the data frame should consist of aggregated counts by clusters (for binary responses), or any cluster-level response (for continuous response). For binary response (<code>responseType = 'binary'</code>), the beta-binomial model will be fitted for cluster-level counts. For continuous response (<code>responseType = 'gaussian'</code>), a Gaussian smoothing model will be fitted on the cluster-level response.</p></li>
<li><p>For unit-level model and <code>is.agg = TRUE</code>, the data frame should be the same as in the area-level model. For binary response (<code>responseType = 'binary'</code>), the beta-binomial model will be fitted for cluster-level counts aggregated internally. For continuous response (<code>responseType = 'gaussian'</code>), the nested error model will be fitted on unit-level response.</p></li>
</ul></dd>


<dt>geo</dt>
<dd><p>Deprecated argument from early versions.</p></dd>


<dt>Amat</dt>
<dd><p>Adjacency matrix for the regions. If set to NULL, the IID spatial effect will be used.</p></dd>


<dt>region.list</dt>
<dd><p>a vector of region names. Only used when IID model is used and the adjacency matrix not specified. This allows the output to include regions with no sample in the data. When the spatial adjacency matrix is specified, the column names of the adjacency matrix will be used to determine region.list. If set to NULL, all regions in the data are used.</p></dd>


<dt>X</dt>
<dd><p>Areal covariates data frame. One of the column name needs to match the <code>regionVar</code> specified in the function call, in order to be linked to the data input. Currently only supporting time-invariant region-level covariates.</p></dd>


<dt>X.unit</dt>
<dd><p>Column names of unit-level covariates. When <code>X.unit</code> is specified, a nested error model will be fitted with unit-level IID noise, and area-level predictions are produced by plugging in the covariate specified in the <code>X</code> argument. When <code>X</code> is not specified, the empirical mean of each covariate will be used. This is only implemented for continuous response with the Gaussian likelihood model and unit-level model.</p></dd>


<dt>responseType</dt>
<dd><p>Type of the response variable, currently supports 'binary' (default with logit link function) or 'gaussian'.</p></dd>


<dt>responseVar</dt>
<dd><p>the response variable</p></dd>


<dt>strataVar</dt>
<dd><p>the strata variable used in the area-level model.</p></dd>


<dt>weightVar</dt>
<dd><p>the weights variable</p></dd>


<dt>regionVar</dt>
<dd><p>Variable name for region.</p></dd>


<dt>clusterVar</dt>
<dd><p>Variable name for cluster. For area-level model, this should be a formula for cluster in survey design object, e.g., '~clusterID + householdID'. For unit-level model, this should be the variable name for cluster unit.</p></dd>


<dt>pc.u</dt>
<dd><p>hyperparameter U for the PC prior on precisions.</p></dd>


<dt>pc.alpha</dt>
<dd><p>hyperparameter alpha for the PC prior on precisions.</p></dd>


<dt>pc.u.phi</dt>
<dd><p>hyperparameter U for the PC prior on the mixture probability phi in BYM2 model.</p></dd>


<dt>pc.alpha.phi</dt>
<dd><p>hyperparameter alpha for the PC prior on the mixture probability phi in BYM2 model.</p></dd>


<dt>CI</dt>
<dd><p>the desired posterior credible interval to calculate</p></dd>


<dt>formula</dt>
<dd><p>a string of user-specified random effects model to be used in the INLA call</p></dd>


<dt>timeVar</dt>
<dd><p>The variable indicating time period. If set to NULL then the temporal model and space-time interaction model are ignored.</p></dd>


<dt>time.model</dt>
<dd><p>the model for temporal trends and interactions. It can be either "rw1" or "rw2".</p></dd>


<dt>include_time_unstruct</dt>
<dd><p>Indicator whether to include the temporal unstructured effects (i.e., shocks) in the smoothed estimates from cluster-level model. The argument only applies to the unit-level models. Default is FALSE which excludes all unstructured temporal components. If set to TRUE all  the unstructured temporal random effects will be included.</p></dd>


<dt>type.st</dt>
<dd><p>can take values 0 (no interaction), or 1 to 4, corresponding to the type I to IV space-time interaction.</p></dd>


<dt>direct.est</dt>
<dd><p>data frame of direct estimates, with column names of response and region specified by <code>responseVar</code>, <code>regionVar</code>, and <code>timeVar</code>.  When <code>direct.est</code> is specified, it overwrites the <code>data</code> input.</p></dd>


<dt>direct.est.var</dt>
<dd><p>the column name corresponding to the variance of direct estimates.</p></dd>


<dt>is.unit.level</dt>
<dd><p>logical indicator of whether unit-level model is fitted instead of area-level model.</p></dd>


<dt>is.agg</dt>
<dd><p>logical indicator of whether the input is at the aggregated counts by cluster. Only used for unit-level model and binary response variable.</p></dd>


<dt>strataVar.within</dt>
<dd><p>the variable specifying within region stratification variable. This is only used for the unit-level model.</p></dd>


<dt>totalVar</dt>
<dd><p>the variable specifying total observations in <code>counts</code>. This is only used for the unit-level model when <code>counts</code> is specified.</p></dd>


<dt>weight.strata</dt>
<dd><p>a data frame with one column corresponding to <code>regionVar</code>, and columns specifying proportion of each strata for each region. This argument specifies the weights for strata-specific estimates. This is only used for the unit-level model.</p></dd>


<dt>nsim</dt>
<dd><p>number of posterior draws to take. This is only used for the unit-level model when <code>weight.strata</code> is provided.</p></dd>


<dt>save.draws</dt>
<dd><p>logical indicator of whether to save the full posterior draws.</p></dd>


<dt>smooth</dt>
<dd><p>logical indicator of whether to perform smoothing. If set to FALSE, a data frame of direct estimate is returned. Only used when <code>is.unit.level</code> is FALSE.</p></dd>


<dt>...</dt>
<dd><p>additional arguments passed to <code>svydesign</code> function.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <dl><dt>HT</dt>
<dd><p>Direct estimates</p></dd>

<dt>smooth</dt>
<dd><p>Smoothed direct estimates</p></dd>

<dt>fit</dt>
<dd><p>a fitted INLA object</p></dd>

<dt>CI</dt>
<dd><p>input argument</p></dd>

<dt>Amat</dt>
<dd><p>input argument</p></dd>

<dt>responseType</dt>
<dd><p>input argument</p></dd>

<dt>formula</dt>
<dd><p>INLA formula</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The function <code>smoothSurvey</code> replaces the previous function name <code>fitGeneric</code> (before version 1.0.0).</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="getDirectList.html">getDirectList</a></code>, <code><a href="smoothDirect.html">smoothDirect</a></code></p></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Zehang Richard Li</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="co">##</span></span></span>
<span class="r-in"><span><span class="co">## 1. Area-level model with binary response</span></span></span>
<span class="r-in"><span><span class="co">##</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">DemoData2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">DemoMap2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fit0</span> <span class="op">&lt;-</span> <span class="fu">smoothSurvey</span><span class="op">(</span>data<span class="op">=</span><span class="va">DemoData2</span>,  </span></span>
<span class="r-in"><span>Amat<span class="op">=</span><span class="va">DemoMap2</span><span class="op">$</span><span class="va">Amat</span>, responseType<span class="op">=</span><span class="st">"binary"</span>, </span></span>
<span class="r-in"><span>responseVar<span class="op">=</span><span class="st">"tobacco.use"</span>, strataVar<span class="op">=</span><span class="st">"strata"</span>, </span></span>
<span class="r-in"><span>weightVar<span class="op">=</span><span class="st">"weights"</span>, regionVar<span class="op">=</span><span class="st">"region"</span>, </span></span>
<span class="r-in"><span>clusterVar <span class="op">=</span> <span class="st">"~clustid+id"</span>, CI <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit0</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># if only direct estimates without smoothing is of interest</span></span></span>
<span class="r-in"><span><span class="va">fit0.dir</span> <span class="op">&lt;-</span> <span class="fu">smoothSurvey</span><span class="op">(</span>data<span class="op">=</span><span class="va">DemoData2</span>,  </span></span>
<span class="r-in"><span>Amat<span class="op">=</span><span class="va">DemoMap2</span><span class="op">$</span><span class="va">Amat</span>, responseType<span class="op">=</span><span class="st">"binary"</span>, </span></span>
<span class="r-in"><span>responseVar<span class="op">=</span><span class="st">"tobacco.use"</span>, strataVar<span class="op">=</span><span class="st">"strata"</span>, </span></span>
<span class="r-in"><span>weightVar<span class="op">=</span><span class="st">"weights"</span>, regionVar<span class="op">=</span><span class="st">"region"</span>, </span></span>
<span class="r-in"><span>clusterVar <span class="op">=</span> <span class="st">"~clustid+id"</span>, CI <span class="op">=</span> <span class="fl">0.95</span>, smooth <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># posterior draws can be returned with save.draws = TRUE</span></span></span>
<span class="r-in"><span><span class="va">fit0.draws</span> <span class="op">&lt;-</span> <span class="fu">smoothSurvey</span><span class="op">(</span>data<span class="op">=</span><span class="va">DemoData2</span>,  </span></span>
<span class="r-in"><span>Amat<span class="op">=</span><span class="va">DemoMap2</span><span class="op">$</span><span class="va">Amat</span>, responseType<span class="op">=</span><span class="st">"binary"</span>, </span></span>
<span class="r-in"><span>responseVar<span class="op">=</span><span class="st">"tobacco.use"</span>, strataVar<span class="op">=</span><span class="st">"strata"</span>, </span></span>
<span class="r-in"><span>weightVar<span class="op">=</span><span class="st">"weights"</span>, regionVar<span class="op">=</span><span class="st">"region"</span>, </span></span>
<span class="r-in"><span>clusterVar <span class="op">=</span> <span class="st">"~clustid+id"</span>, CI <span class="op">=</span> <span class="fl">0.95</span>, save.draws <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># notice the posterior draws are on the latent scale</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fit0.draws</span><span class="op">$</span><span class="va">draws.est</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span> </span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example with region-level covariates</span></span></span>
<span class="r-in"><span> <span class="va">Xmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">age</span><span class="op">~</span><span class="va">region</span>, data <span class="op">=</span> <span class="va">DemoData2</span>, </span></span>
<span class="r-in"><span>            FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span> <span class="va">fit1</span> <span class="op">&lt;-</span> <span class="fu">smoothSurvey</span><span class="op">(</span>data<span class="op">=</span><span class="va">DemoData2</span>,  </span></span>
<span class="r-in"><span>  Amat<span class="op">=</span><span class="va">DemoMap2</span><span class="op">$</span><span class="va">Amat</span>, responseType<span class="op">=</span><span class="st">"binary"</span>, </span></span>
<span class="r-in"><span>  X <span class="op">=</span> <span class="va">Xmat</span>,</span></span>
<span class="r-in"><span>  responseVar<span class="op">=</span><span class="st">"tobacco.use"</span>, strataVar<span class="op">=</span><span class="st">"strata"</span>, </span></span>
<span class="r-in"><span>  weightVar<span class="op">=</span><span class="st">"weights"</span>, regionVar<span class="op">=</span><span class="st">"region"</span>, </span></span>
<span class="r-in"><span>  clusterVar <span class="op">=</span> <span class="st">"~clustid+id"</span>, CI <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example with using only direct estimates as input instead of the full data</span></span></span>
<span class="r-in"><span><span class="va">direct</span> <span class="op">&lt;-</span> <span class="va">fit0</span><span class="op">$</span><span class="va">HT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"region"</span>, <span class="st">"HT.est"</span>, <span class="st">"HT.var"</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu">smoothSurvey</span><span class="op">(</span>data<span class="op">=</span><span class="cn">NULL</span>, direct.est <span class="op">=</span> <span class="va">direct</span>, </span></span>
<span class="r-in"><span>                    Amat<span class="op">=</span><span class="va">DemoMap2</span><span class="op">$</span><span class="va">Amat</span>, regionVar<span class="op">=</span><span class="st">"region"</span>,</span></span>
<span class="r-in"><span>                    responseVar<span class="op">=</span><span class="st">"HT.est"</span>, direct.est.var <span class="op">=</span> <span class="st">"HT.var"</span>, </span></span>
<span class="r-in"><span>                    responseType <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Check it is the same as fit0</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit2</span><span class="op">$</span><span class="va">smooth</span><span class="op">$</span><span class="va">mean</span>, <span class="va">fit0</span><span class="op">$</span><span class="va">smooth</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example with using only direct estimates as input, </span></span></span>
<span class="r-in"><span><span class="co">#   and after transformation into a Gaussian smoothing model</span></span></span>
<span class="r-in"><span><span class="co"># Notice: the output are on the same scale as the input </span></span></span>
<span class="r-in"><span><span class="co">#   and in this case, the logit estimates.    </span></span></span>
<span class="r-in"><span><span class="va">direct.logit</span> <span class="op">&lt;-</span> <span class="va">fit0</span><span class="op">$</span><span class="va">HT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"region"</span>, <span class="st">"HT.logit.est"</span>, <span class="st">"HT.logit.var"</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">fit3</span> <span class="op">&lt;-</span> <span class="fu">smoothSurvey</span><span class="op">(</span>data<span class="op">=</span><span class="cn">NULL</span>, direct.est <span class="op">=</span> <span class="va">direct.logit</span>, </span></span>
<span class="r-in"><span>               Amat<span class="op">=</span><span class="va">DemoMap2</span><span class="op">$</span><span class="va">Amat</span>, regionVar<span class="op">=</span><span class="st">"region"</span>,</span></span>
<span class="r-in"><span>               responseVar<span class="op">=</span><span class="st">"HT.logit.est"</span>, direct.est.var <span class="op">=</span> <span class="st">"HT.logit.var"</span>,</span></span>
<span class="r-in"><span>               responseType <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Check it is the same as fit0</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit3</span><span class="op">$</span><span class="va">smooth</span><span class="op">$</span><span class="va">mean</span>, <span class="va">fit0</span><span class="op">$</span><span class="va">smooth</span><span class="op">$</span><span class="va">logit.mean</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example with non-spatial smoothing using IID random effects</span></span></span>
<span class="r-in"><span><span class="va">fit4</span> <span class="op">&lt;-</span> <span class="fu">smoothSurvey</span><span class="op">(</span>data<span class="op">=</span><span class="va">DemoData2</span>, responseType<span class="op">=</span><span class="st">"binary"</span>, </span></span>
<span class="r-in"><span>       responseVar<span class="op">=</span><span class="st">"tobacco.use"</span>, strataVar<span class="op">=</span><span class="st">"strata"</span>, </span></span>
<span class="r-in"><span>       weightVar<span class="op">=</span><span class="st">"weights"</span>, regionVar<span class="op">=</span><span class="st">"region"</span>, </span></span>
<span class="r-in"><span>       clusterVar <span class="op">=</span> <span class="st">"~clustid+id"</span>, CI <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example with missing regions in the raw input</span></span></span>
<span class="r-in"><span><span class="va">DemoData2.sub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">DemoData2</span>, <span class="va">region</span> <span class="op">!=</span> <span class="st">"central"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fit.without.central</span> <span class="op">&lt;-</span> <span class="fu">smoothSurvey</span><span class="op">(</span>data<span class="op">=</span><span class="va">DemoData2.sub</span>,  </span></span>
<span class="r-in"><span>                         Amat<span class="op">=</span><span class="cn">NULL</span>, responseType<span class="op">=</span><span class="st">"binary"</span>, </span></span>
<span class="r-in"><span>                         responseVar<span class="op">=</span><span class="st">"tobacco.use"</span>, strataVar<span class="op">=</span><span class="st">"strata"</span>, </span></span>
<span class="r-in"><span>                         weightVar<span class="op">=</span><span class="st">"weights"</span>, regionVar<span class="op">=</span><span class="st">"region"</span>, </span></span>
<span class="r-in"><span>                         clusterVar <span class="op">=</span> <span class="st">"~clustid+id"</span>, CI <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fit.without.central</span><span class="op">$</span><span class="va">HT</span></span></span>
<span class="r-in"><span><span class="va">fit.without.central</span><span class="op">$</span><span class="va">smooth</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">fit.without.central</span> <span class="op">&lt;-</span> <span class="fu">smoothSurvey</span><span class="op">(</span>data<span class="op">=</span><span class="va">DemoData2.sub</span>,  </span></span>
<span class="r-in"><span>                         Amat<span class="op">=</span><span class="cn">NULL</span>, region.list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">DemoData2</span><span class="op">$</span><span class="va">region</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                         responseType<span class="op">=</span><span class="st">"binary"</span>, </span></span>
<span class="r-in"><span>                         responseVar<span class="op">=</span><span class="st">"tobacco.use"</span>, strataVar<span class="op">=</span><span class="st">"strata"</span>, </span></span>
<span class="r-in"><span>                         weightVar<span class="op">=</span><span class="st">"weights"</span>, regionVar<span class="op">=</span><span class="st">"region"</span>, </span></span>
<span class="r-in"><span>                         clusterVar <span class="op">=</span> <span class="st">"~clustid+id"</span>, CI <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fit.with.central</span><span class="op">$</span><span class="va">HT</span></span></span>
<span class="r-in"><span><span class="va">fit.with.central</span><span class="op">$</span><span class="va">smooth</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Using the formula argument, further customizations can be added to the </span></span></span>
<span class="r-in"><span><span class="co">#  model fitted. For example, we can fit the Fay-Harriot model with </span></span></span>
<span class="r-in"><span><span class="co">#  IID effect instead of the BYM2 random effect as follows.</span></span></span>
<span class="r-in"><span><span class="co">#  The "region.struct" and "hyperpc1" are picked to match internal object </span></span></span>
<span class="r-in"><span><span class="co">#  names. Other object names can be inspected from the source of smoothSurvey.</span></span></span>
<span class="r-in"><span><span class="va">fit5</span> <span class="op">&lt;-</span> <span class="fu">smoothSurvey</span><span class="op">(</span>data<span class="op">=</span><span class="va">DemoData2</span>,  </span></span>
<span class="r-in"><span>       Amat<span class="op">=</span><span class="va">DemoMap2</span><span class="op">$</span><span class="va">Amat</span>, responseType<span class="op">=</span><span class="st">"binary"</span>, </span></span>
<span class="r-in"><span>       formula <span class="op">=</span> <span class="st">"f(region.struct, model = 'iid', hyper = hyperpc1)"</span>,</span></span>
<span class="r-in"><span>       pc.u <span class="op">=</span> <span class="fl">1</span>, pc.alpha <span class="op">=</span> <span class="fl">0.01</span>,</span></span>
<span class="r-in"><span>       responseVar<span class="op">=</span><span class="st">"tobacco.use"</span>, strataVar<span class="op">=</span><span class="st">"strata"</span>, </span></span>
<span class="r-in"><span>       weightVar<span class="op">=</span><span class="st">"weights"</span>, regionVar<span class="op">=</span><span class="st">"region"</span>, </span></span>
<span class="r-in"><span>       clusterVar <span class="op">=</span> <span class="st">"~clustid+id"</span>, CI <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Check it is the same as fit4, notice the region order may be different</span></span></span>
<span class="r-in"><span><span class="va">regions</span> <span class="op">&lt;-</span> <span class="va">fit5</span><span class="op">$</span><span class="va">smooth</span><span class="op">$</span><span class="va">region</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit4</span><span class="op">$</span><span class="va">smooth</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">regions</span>, <span class="va">fit4</span><span class="op">$</span><span class="va">smooth</span><span class="op">$</span><span class="va">region</span><span class="op">)</span>,<span class="op">]</span><span class="op">$</span><span class="va">logit.mean</span>, <span class="va">fit5</span><span class="op">$</span><span class="va">smooth</span><span class="op">$</span><span class="va">logit.mean</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">##</span></span></span>
<span class="r-in"><span><span class="co">## 2. Unit-level model with binary response  </span></span></span>
<span class="r-in"><span><span class="co">##</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># For unit-level models, we need to create stratification variable within regions</span></span></span>
<span class="r-in"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">DemoData2</span></span></span>
<span class="r-in"><span><span class="va">data</span><span class="op">$</span><span class="va">urbanicity</span> <span class="op">&lt;-</span> <span class="st">"rural"</span></span></span>
<span class="r-in"><span><span class="va">data</span><span class="op">$</span><span class="va">urbanicity</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"urban"</span>, <span class="va">data</span><span class="op">$</span><span class="va">strata</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"urban"</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Beta-binomial likelihood is used in this model</span></span></span>
<span class="r-in"><span><span class="va">fit6</span> <span class="op">&lt;-</span> <span class="fu">smoothSurvey</span><span class="op">(</span>data<span class="op">=</span><span class="va">data</span>, </span></span>
<span class="r-in"><span>  Amat<span class="op">=</span><span class="va">DemoMap2</span><span class="op">$</span><span class="va">Amat</span>, responseType<span class="op">=</span><span class="st">"binary"</span>, </span></span>
<span class="r-in"><span>  X <span class="op">=</span> <span class="va">Xmat</span>, is.unit.level <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>  responseVar<span class="op">=</span><span class="st">"tobacco.use"</span>, strataVar.within <span class="op">=</span> <span class="st">"urbanicity"</span>, </span></span>
<span class="r-in"><span>  regionVar<span class="op">=</span><span class="st">"region"</span>, clusterVar <span class="op">=</span> <span class="st">"clustid"</span>, CI <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># We may use aggregated PSU-level counts as input as well</span></span></span>
<span class="r-in"><span><span class="co">#    in the case of modeling a binary outcome </span></span></span>
<span class="r-in"><span><span class="va">data.agg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">tobacco.use</span><span class="op">~</span><span class="va">region</span> <span class="op">+</span> <span class="va">urbanicity</span> <span class="op">+</span> <span class="va">clustid</span>, </span></span>
<span class="r-in"><span>                      data <span class="op">=</span> <span class="va">data</span>, FUN <span class="op">=</span> <span class="va">sum</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">data.agg.total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">tobacco.use</span><span class="op">~</span><span class="va">region</span> <span class="op">+</span> <span class="va">urbanicity</span> <span class="op">+</span> <span class="va">clustid</span>, </span></span>
<span class="r-in"><span>                      data <span class="op">=</span> <span class="va">data</span>, FUN <span class="op">=</span> <span class="va">length</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data.agg.total</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"total"</span></span></span>
<span class="r-in"><span><span class="va">data.agg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://edzer.github.io/sp/reference/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">data.agg</span>, <span class="va">data.agg.total</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data.agg</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">fit7</span> <span class="op">&lt;-</span> <span class="fu">smoothSurvey</span><span class="op">(</span>data<span class="op">=</span><span class="va">data.agg</span>, </span></span>
<span class="r-in"><span>  Amat<span class="op">=</span><span class="va">DemoMap2</span><span class="op">$</span><span class="va">Amat</span>, responseType<span class="op">=</span><span class="st">"binary"</span>, </span></span>
<span class="r-in"><span>  X <span class="op">=</span> <span class="va">Xmat</span>, is.unit.level <span class="op">=</span> <span class="cn">TRUE</span>, is.agg <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>  responseVar <span class="op">=</span> <span class="st">"tobacco.use"</span>, strataVar.within <span class="op">=</span> <span class="st">"urbanicity"</span>, </span></span>
<span class="r-in"><span>  totalVar <span class="op">=</span> <span class="st">"total"</span>, regionVar<span class="op">=</span><span class="st">"region"</span>, clusterVar <span class="op">=</span> <span class="st">"clustid"</span>, CI <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Check it is the same as fit6</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit6</span><span class="op">$</span><span class="va">smooth</span><span class="op">$</span><span class="va">mean</span>, <span class="va">fit7</span><span class="op">$</span><span class="va">smooth</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span>  </span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">##</span></span></span>
<span class="r-in"><span><span class="co">## 3. Area-level model with continuous response</span></span></span>
<span class="r-in"><span><span class="co">##</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># The smoothing model is the same as area-level model with binary response</span></span></span>
<span class="r-in"><span><span class="co">#  the continuous direct estimates are smoothed instead of </span></span></span>
<span class="r-in"><span><span class="co">#  their logit-transformed versions for binary response.</span></span></span>
<span class="r-in"><span><span class="va">fit8</span> <span class="op">&lt;-</span> <span class="fu">smoothSurvey</span><span class="op">(</span>data<span class="op">=</span><span class="va">DemoData2</span>, Amat<span class="op">=</span><span class="va">DemoMap2</span><span class="op">$</span><span class="va">Amat</span>, </span></span>
<span class="r-in"><span>       responseType<span class="op">=</span><span class="st">"gaussian"</span>, responseVar<span class="op">=</span><span class="st">"age"</span>, strataVar<span class="op">=</span><span class="st">"strata"</span>, </span></span>
<span class="r-in"><span>       weightVar<span class="op">=</span><span class="st">"weights"</span>, regionVar<span class="op">=</span><span class="st">"region"</span>, </span></span>
<span class="r-in"><span>       pc.u.phi <span class="op">=</span> <span class="fl">0.5</span>, pc.alpha.phi <span class="op">=</span> <span class="fl">0.5</span>,</span></span>
<span class="r-in"><span>       clusterVar <span class="op">=</span> <span class="st">"~clustid+id"</span>, CI <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">##</span></span></span>
<span class="r-in"><span><span class="co">## 4. Unit-level model with continuous response  </span></span></span>
<span class="r-in"><span><span class="co">##    (or nested error models)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># The unit-level model assumes for each of the i-th unit,</span></span></span>
<span class="r-in"><span><span class="co">#    Y_{i} ~ intercept + region_effect + IID_i</span></span></span>
<span class="r-in"><span><span class="co">#    where IID_i is the error term specific to i-th unit</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># When more than one level of cluster sampling is carried out, </span></span></span>
<span class="r-in"><span><span class="co">#   they are ignored here. Only the input unit is considered.</span></span></span>
<span class="r-in"><span><span class="co">#   So here we do not need to specify clusterVar any more. </span></span></span>
<span class="r-in"><span><span class="va">fit9</span> <span class="op">&lt;-</span> <span class="fu">smoothSurvey</span><span class="op">(</span>data<span class="op">=</span> <span class="va">data</span>, </span></span>
<span class="r-in"><span>  Amat<span class="op">=</span><span class="va">DemoMap2</span><span class="op">$</span><span class="va">Amat</span>, responseType<span class="op">=</span><span class="st">"gaussian"</span>, </span></span>
<span class="r-in"><span>  is.unit.level <span class="op">=</span> <span class="cn">TRUE</span>, responseVar<span class="op">=</span><span class="st">"age"</span>, strataVar.within <span class="op">=</span> <span class="cn">NULL</span>,</span></span>
<span class="r-in"><span>  regionVar<span class="op">=</span><span class="st">"region"</span>, clusterVar <span class="op">=</span> <span class="cn">NULL</span>, CI <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># To compare, we may also model PSU-level responses. As an illustration, </span></span></span>
<span class="r-in"><span><span class="va">data.median</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">age</span><span class="op">~</span><span class="va">region</span> <span class="op">+</span> <span class="va">urbanicity</span> <span class="op">+</span> <span class="va">clustid</span>, </span></span>
<span class="r-in"><span>                      data <span class="op">=</span> <span class="va">data</span>, FUN <span class="op">=</span> <span class="va">median</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">fit10</span> <span class="op">&lt;-</span> <span class="fu">smoothSurvey</span><span class="op">(</span>data<span class="op">=</span> <span class="va">data.median</span>, </span></span>
<span class="r-in"><span>  Amat<span class="op">=</span><span class="va">DemoMap2</span><span class="op">$</span><span class="va">Amat</span>, responseType<span class="op">=</span><span class="st">"gaussian"</span>, </span></span>
<span class="r-in"><span>  is.unit.level <span class="op">=</span> <span class="cn">TRUE</span>, responseVar<span class="op">=</span><span class="st">"age"</span>, strataVar.within <span class="op">=</span> <span class="cn">NULL</span>,</span></span>
<span class="r-in"><span>  regionVar<span class="op">=</span><span class="st">"region"</span>, clusterVar <span class="op">=</span> <span class="st">"clustid"</span>, CI <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># To further incorporate within-area stratification</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">fit11</span> <span class="op">&lt;-</span> <span class="fu">smoothSurvey</span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, </span></span>
<span class="r-in"><span>  Amat <span class="op">=</span> <span class="va">DemoMap2</span><span class="op">$</span><span class="va">Amat</span>, responseType <span class="op">=</span> <span class="st">"gaussian"</span>, </span></span>
<span class="r-in"><span>  is.unit.level <span class="op">=</span> <span class="cn">TRUE</span>, responseVar<span class="op">=</span><span class="st">"age"</span>, strataVar.within <span class="op">=</span> <span class="st">"urbanicity"</span>,</span></span>
<span class="r-in"><span>  regionVar <span class="op">=</span> <span class="st">"region"</span>, clusterVar <span class="op">=</span> <span class="cn">NULL</span>, CI <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span>  </span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Notice the usual output is now stratified within each region</span></span></span>
<span class="r-in"><span><span class="co"># The aggregated estimates require strata proportions for each region</span></span></span>
<span class="r-in"><span><span class="co"># For illustration, we set strata population proportions below</span></span></span>
<span class="r-in"><span><span class="va">prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>region <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">region</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>                            urban <span class="op">=</span> <span class="fl">0.3</span>, </span></span>
<span class="r-in"><span>                            rural <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fit12</span> <span class="op">&lt;-</span> <span class="fu">smoothSurvey</span><span class="op">(</span>data<span class="op">=</span><span class="va">data</span>, </span></span>
<span class="r-in"><span>  Amat<span class="op">=</span><span class="va">DemoMap2</span><span class="op">$</span><span class="va">Amat</span>, responseType<span class="op">=</span><span class="st">"gaussian"</span>, </span></span>
<span class="r-in"><span>  is.unit.level <span class="op">=</span> <span class="cn">TRUE</span>, responseVar<span class="op">=</span><span class="st">"age"</span>, strataVar.within <span class="op">=</span> <span class="st">"urbanicity"</span>,</span></span>
<span class="r-in"><span>  regionVar<span class="op">=</span><span class="st">"region"</span>, clusterVar <span class="op">=</span> <span class="cn">NULL</span>, CI <span class="op">=</span> <span class="fl">0.95</span>,</span></span>
<span class="r-in"><span>  weight.strata <span class="op">=</span> <span class="va">prop</span><span class="op">)</span>  </span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># aggregated outcome</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fit12</span><span class="op">$</span><span class="va">smooth.overall</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Compare aggregated outcome with direct aggregating posterior means. </span></span></span>
<span class="r-in"><span><span class="co"># There could be small differences if only 1000 posterior draws are taken.</span></span></span>
<span class="r-in"><span><span class="va">est.urb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">fit11</span><span class="op">$</span><span class="va">smooth</span>, <span class="va">strata</span> <span class="op">==</span> <span class="st">"urban"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">est.rural</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">fit11</span><span class="op">$</span><span class="va">smooth</span>, <span class="va">strata</span> <span class="op">==</span> <span class="st">"rural"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">est.mean.post</span> <span class="op">&lt;-</span> <span class="va">est.urb</span><span class="op">$</span><span class="va">mean</span> <span class="op">*</span> <span class="fl">0.3</span> <span class="op">+</span> <span class="va">est.rural</span><span class="op">$</span><span class="va">mean</span> <span class="op">*</span> <span class="fl">0.7</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit12</span><span class="op">$</span><span class="va">smooth.overall</span><span class="op">$</span><span class="va">mean</span>, <span class="va">est.mean.post</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">##</span></span></span>
<span class="r-in"><span><span class="co">## 6. Unit-level model with continuous response and unit-level covariate </span></span></span>
<span class="r-in"><span><span class="co">## </span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># For area-level prediction, area-level covariate mean needs to be  </span></span></span>
<span class="r-in"><span><span class="co">#   specified in X argument. And unit-level covariate names are specified</span></span></span>
<span class="r-in"><span><span class="co">#   in X.unit argument.</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>region <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fl">1000</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                   X1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">4000</span><span class="op">)</span>, X2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">4000</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">Xmean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">.</span><span class="op">~</span><span class="va">region</span>, data <span class="op">=</span> <span class="va">sim</span>, FUN <span class="op">=</span> <span class="va">sum</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">sim</span><span class="op">$</span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">4000</span>, mean <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">X1</span> <span class="op">+</span> <span class="fl">0.3</span> <span class="op">*</span> <span class="va">sim</span><span class="op">$</span><span class="va">X2</span> <span class="op">+</span> <span class="va">sim</span><span class="op">$</span><span class="va">region</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">samp</span> <span class="op">&lt;-</span> <span class="va">sim</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4000</span>, <span class="fl">20</span><span class="op">)</span>, <span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">fit.sim</span> <span class="op">&lt;-</span> <span class="fu">smoothSurvey</span><span class="op">(</span>data<span class="op">=</span><span class="va">samp</span> , </span></span>
<span class="r-in"><span>                  X.unit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X1"</span>, <span class="st">"X2"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                  X <span class="op">=</span> <span class="va">Xmean</span>, Amat<span class="op">=</span><span class="cn">NULL</span>, responseType<span class="op">=</span><span class="st">"gaussian"</span>, </span></span>
<span class="r-in"><span>                  is.unit.level <span class="op">=</span> <span class="cn">TRUE</span>, responseVar<span class="op">=</span><span class="st">"Y"</span>, regionVar <span class="op">=</span> <span class="st">"region"</span>,  </span></span>
<span class="r-in"><span>                  pc.u <span class="op">=</span> <span class="fl">1</span>, pc.alpha <span class="op">=</span> <span class="fl">0.01</span>, CI <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span> </span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Zehang R Li, Bryan D Martin, Yuan Hsiao, Jessica Godwin, John Paige, Peter Gao, Jon Wakefield, Samuel J Clark, Geir-Arne Fuglstad, Andrea Riebler.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer></div>

  

  

  </body></html>

